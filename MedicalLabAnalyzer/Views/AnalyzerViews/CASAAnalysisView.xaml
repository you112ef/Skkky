<UserControl x:Class="MedicalLabAnalyzer.Views.AnalyzerViews.CASAAnalysisView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             mc:Ignorable="d"
             FlowDirection="RightToLeft"
             FontFamily="Segoe UI, Arial"
             d:DesignHeight="900" d:DesignWidth="1400">

    <UserControl.Resources>
        <!-- CASA Analysis Styles -->
        <Style x:Key="CASAPanelStyle" TargetType="materialDesign:Card">
            <Setter Property="materialDesign:ElevationAssist.Elevation" Value="Dp4"/>
            <Setter Property="Padding" Value="16"/>
            <Setter Property="Margin" Value="8"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
        </Style>

        <Style x:Key="MediaViewerStyle" TargetType="materialDesign:Card">
            <Setter Property="materialDesign:ElevationAssist.Elevation" Value="Dp8"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="8"/>
            <Setter Property="Background" Value="Black"/>
            <Setter Property="CornerRadius" Value="8"/>
        </Style>

        <Style x:Key="CASAMetricStyle" TargetType="Border">
            <Setter Property="Background" Value="#F8F9FA"/>
            <Setter Property="BorderBrush" Value="#E0E0E0"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="Margin" Value="4"/>
        </Style>

        <Style x:Key="MetricValueStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Foreground" Value="#1976D2"/>
        </Style>

        <Style x:Key="MetricLabelStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Foreground" Value="#666666"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
        </Style>

        <Style x:Key="AnalysisButtonStyle" TargetType="Button" BasedOn="{StaticResource MaterialDesignRaisedButton}">
            <Setter Property="Height" Value="48"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Margin" Value="4"/>
        </Style>

        <!-- AI Status Indicators -->
        <Style x:Key="AIStatusStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Margin" Value="4,0"/>
        </Style>

        <!-- Progress Styles -->
        <Style x:Key="AnalysisProgressStyle" TargetType="ProgressBar">
            <Setter Property="Height" Value="6"/>
            <Setter Property="Foreground" Value="#4CAF50"/>
            <Setter Property="Background" Value="#E0E0E0"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Header -->
            <RowDefinition Height="*"/>     <!-- Main Content -->
            <RowDefinition Height="Auto"/>  <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <materialDesign:Card Grid.Row="0" Style="{StaticResource CASAPanelStyle}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Title and AI Status -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="VideoBox" 
                                           Width="32" Height="32" 
                                           Foreground="#1976D2"
                                           VerticalAlignment="Center"
                                           Margin="0,0,12,0"/>
                    <StackPanel>
                        <TextBlock Text="تحليل الحيوانات المنوية CASA" 
                                 FontSize="20" 
                                 FontWeight="Bold"
                                 Foreground="#1976D2"/>
                        <TextBlock Text="Computer Assisted Semen Analysis with AI" 
                                 FontSize="12"
                                 Foreground="#666666"/>
                    </StackPanel>
                </StackPanel>

                <!-- AI Status Indicators -->
                <StackPanel Grid.Column="1" 
                          Orientation="Horizontal" 
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center">
                    
                    <!-- YOLOv8 Status -->
                    <Border Style="{StaticResource AIStatusStyle}"
                          Background="{Binding YOLOv8StatusBrush}">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Eye" 
                                                   Width="16" Height="16" 
                                                   Foreground="White"
                                                   VerticalAlignment="Center"
                                                   Margin="0,0,4,0"/>
                            <TextBlock Text="YOLOv8" 
                                     Foreground="White" 
                                     FontSize="11"
                                     FontWeight="SemiBold"
                                     VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- DeepSORT Status -->
                    <Border Style="{StaticResource AIStatusStyle}"
                          Background="{Binding DeepSORTStatusBrush}">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="VectorPolyline" 
                                                   Width="16" Height="16" 
                                                   Foreground="White"
                                                   VerticalAlignment="Center"
                                                   Margin="0,0,4,0"/>
                            <TextBlock Text="DeepSORT" 
                                     Foreground="White" 
                                     FontSize="11"
                                     FontWeight="SemiBold"
                                     VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- OpenCV Status -->
                    <Border Style="{StaticResource AIStatusStyle}"
                          Background="{Binding OpenCVStatusBrush}">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="ImageFilterCenterFocus" 
                                                   Width="16" Height="16" 
                                                   Foreground="White"
                                                   VerticalAlignment="Center"
                                                   Margin="0,0,4,0"/>
                            <TextBlock Text="OpenCV" 
                                     Foreground="White" 
                                     FontSize="11"
                                     FontWeight="SemiBold"
                                     VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Action Buttons -->
                <StackPanel Grid.Column="2" 
                          Orientation="Horizontal"
                          VerticalAlignment="Center">
                    <Button Content="تحميل وسائط"
                          Style="{StaticResource AnalysisButtonStyle}"
                          Background="#2196F3"
                          BorderBrush="#2196F3"
                          Command="{Binding LoadMediaCommand}">
                        <Button.ToolTip>
                            <ToolTip Content="تحميل صور أو فيديو للتحليل"/>
                        </Button.ToolTip>
                    </Button>
                    
                    <Button Content="بدء التحليل"
                          Style="{StaticResource AnalysisButtonStyle}"
                          Background="#4CAF50"
                          BorderBrush="#4CAF50"
                          Command="{Binding StartAnalysisCommand}"
                          IsEnabled="{Binding CanStartAnalysis}">
                        <Button.ToolTip>
                            <ToolTip Content="بدء تحليل الذكاء الاصطناعي"/>
                        </Button.ToolTip>
                    </Button>
                </StackPanel>
            </Grid>
        </materialDesign:Card>

        <!-- Main Content -->
        <Grid Grid.Row="1" Margin="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>  <!-- Media Viewer -->
                <ColumnDefinition Width="*"/>   <!-- Analysis Panel -->
            </Grid.ColumnDefinitions>

            <!-- Media Viewer Section -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>    <!-- Viewer -->
                    <RowDefinition Height="Auto"/> <!-- Controls -->
                </Grid.RowDefinitions>

                <!-- Media Display -->
                <materialDesign:Card Grid.Row="0" Style="{StaticResource MediaViewerStyle}">
                    <Grid>
                        <!-- Image Display -->
                        <Image Name="ImageViewer"
                             Source="{Binding CurrentImageSource}"
                             Stretch="Uniform"
                             Visibility="{Binding IsImageMode, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                        <!-- Video Display -->
                        <MediaElement Name="VideoPlayer"
                                    Source="{Binding CurrentVideoSource}"
                                    Stretch="Uniform"
                                    LoadedBehavior="Manual"
                                    Visibility="{Binding IsVideoMode, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                        <!-- Analysis Overlay -->
                        <Canvas Name="AnalysisOverlay"
                              Background="Transparent"
                              Visibility="{Binding ShowAnalysisOverlay, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <!-- Sperm Detection Boxes -->
                            <ItemsControl ItemsSource="{Binding DetectedSperms}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemContainerStyle>
                                    <Style TargetType="ContentPresenter">
                                        <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                        <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                                    </Style>
                                </ItemsControl.ItemContainerStyle>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="{Binding StatusColor}"
                                              BorderThickness="2"
                                              Width="{Binding Width}"
                                              Height="{Binding Height}"
                                              Background="Transparent">
                                            <Border.ToolTip>
                                                <ToolTip>
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding SpermId, StringFormat='ID: {0}'}"/>
                                                        <TextBlock Text="{Binding Confidence, StringFormat='ثقة: {0:P1}'}"/>
                                                        <TextBlock Text="{Binding Status}"/>
                                                    </StackPanel>
                                                </ToolTip>
                                            </Border.ToolTip>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Motion Tracks -->
                            <ItemsControl ItemsSource="{Binding SpermTracks}"
                                        Visibility="{Binding IsVideoMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Polyline Points="{Binding TrackPoints}"
                                                Stroke="{Binding TrackColor}"
                                                StrokeThickness="2"
                                                Opacity="0.7"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Canvas>

                        <!-- Loading Overlay -->
                        <Grid Background="#80000000"
                            Visibility="{Binding IsAnalyzing, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel HorizontalAlignment="Center" 
                                      VerticalAlignment="Center">
                                <materialDesign:PackIcon Kind="Loading" 
                                                       Width="48" Height="48" 
                                                       Foreground="White"
                                                       HorizontalAlignment="Center">
                                    <materialDesign:PackIcon.RenderTransform>
                                        <RotateTransform/>
                                    </materialDesign:PackIcon.RenderTransform>
                                    <materialDesign:PackIcon.Triggers>
                                        <EventTrigger RoutedEvent="Loaded">
                                            <BeginStoryboard>
                                                <Storyboard RepeatBehavior="Forever">
                                                    <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                                                                   From="0" To="360" Duration="0:0:1"/>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </EventTrigger>
                                    </materialDesign:PackIcon.Triggers>
                                </materialDesign:PackIcon>
                                
                                <TextBlock Text="{Binding AnalysisStatusText}" 
                                         Foreground="White" 
                                         FontSize="16" 
                                         HorizontalAlignment="Center"
                                         Margin="0,16,0,8"/>
                                
                                <ProgressBar Style="{StaticResource AnalysisProgressStyle}"
                                           Width="200"
                                           Value="{Binding AnalysisProgress}"/>
                                
                                <TextBlock Text="{Binding AnalysisProgress, StringFormat='{0:F1}%'}" 
                                         Foreground="White" 
                                         FontSize="12"
                                         HorizontalAlignment="Center"
                                         Margin="0,8,0,0"/>
                            </StackPanel>
                        </Grid>

                        <!-- Drop Zone -->
                        <Grid Background="#40000000"
                            Visibility="{Binding ShowDropZone, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel HorizontalAlignment="Center" 
                                      VerticalAlignment="Center">
                                <materialDesign:PackIcon Kind="CloudUpload" 
                                                       Width="64" Height="64" 
                                                       Foreground="White"
                                                       HorizontalAlignment="Center"
                                                       Margin="0,0,0,16"/>
                                <TextBlock Text="اسحب الصور أو الفيديو هنا" 
                                         Foreground="White" 
                                         FontSize="18"
                                         FontWeight="SemiBold"
                                         HorizontalAlignment="Center"/>
                                <TextBlock Text="أو اضغط لتحديد الملفات" 
                                         Foreground="#E0E0E0" 
                                         FontSize="14"
                                         HorizontalAlignment="Center"
                                         Margin="0,8,0,0"/>
                                <TextBlock Text=".jpg, .png, .mp4, .avi" 
                                         Foreground="#BDBDBD" 
                                         FontSize="12"
                                         HorizontalAlignment="Center"
                                         Margin="0,16,0,0"/>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </materialDesign:Card>

                <!-- Media Controls -->
                <materialDesign:Card Grid.Row="1" 
                                   Style="{StaticResource CASAPanelStyle}"
                                   Visibility="{Binding IsVideoMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel>
                        <!-- Video Controls -->
                        <StackPanel Orientation="Horizontal" 
                                  HorizontalAlignment="Center"
                                  Margin="0,0,0,8">
                            <Button Name="PlayPauseButton"
                                  Style="{StaticResource MaterialDesignIconForegroundButton}"
                                  Command="{Binding PlayPauseCommand}">
                                <materialDesign:PackIcon Kind="{Binding PlayPauseIcon}" 
                                                       Width="24" Height="24"/>
                            </Button>
                            
                            <Button Style="{StaticResource MaterialDesignIconForegroundButton}"
                                  Command="{Binding StopCommand}">
                                <materialDesign:PackIcon Kind="Stop" 
                                                       Width="24" Height="24"/>
                            </Button>
                            
                            <Button Style="{StaticResource MaterialDesignIconForegroundButton}"
                                  Command="{Binding PreviousFrameCommand}">
                                <materialDesign:PackIcon Kind="SkipPrevious" 
                                                       Width="24" Height="24"/>
                            </Button>
                            
                            <Button Style="{StaticResource MaterialDesignIconForegroundButton}"
                                  Command="{Binding NextFrameCommand}">
                                <materialDesign:PackIcon Kind="SkipNext" 
                                                       Width="24" Height="24"/>
                            </Button>
                        </StackPanel>

                        <!-- Timeline Slider -->
                        <Slider Name="VideoTimeline"
                              Minimum="0"
                              Maximum="{Binding VideoDuration}"
                              Value="{Binding VideoPosition, Mode=TwoWay}"
                              IsEnabled="{Binding IsVideoLoaded}"
                              Margin="16,0"/>

                        <!-- Time Display -->
                        <StackPanel Orientation="Horizontal" 
                                  HorizontalAlignment="Center"
                                  Margin="0,8,0,0">
                            <TextBlock Text="{Binding VideoPosition, StringFormat='{0:mm\\:ss}'}" 
                                     FontSize="12"/>
                            <TextBlock Text=" / " 
                                     FontSize="12"/>
                            <TextBlock Text="{Binding VideoDuration, StringFormat='{0:mm\\:ss}'}" 
                                     FontSize="12"/>
                        </StackPanel>
                    </StackPanel>
                </materialDesign:Card>
            </Grid>

            <!-- Analysis Results Panel -->
            <Grid Grid.Column="1">
                <ScrollViewer VerticalScrollBarVisibility="Auto" 
                            HorizontalScrollBarVisibility="Disabled">
                    <StackPanel>
                        <!-- File Information -->
                        <materialDesign:Card Style="{StaticResource CASAPanelStyle}">
                            <StackPanel>
                                <TextBlock Text="معلومات الملف" 
                                         FontSize="16" 
                                         FontWeight="SemiBold"
                                         Foreground="#1976D2"
                                         Margin="0,0,0,12"/>
                                
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="اسم الملف:" FontSize="12" Foreground="#666666"/>
                                        <TextBlock Text="{Binding CurrentFileName}" 
                                                 FontSize="12" 
                                                 FontWeight="SemiBold"
                                                 TextTrimming="CharacterEllipsis"
                                                 Margin="0,2,0,8"/>
                                        
                                        <TextBlock Text="حجم الملف:" FontSize="12" Foreground="#666666"/>
                                        <TextBlock Text="{Binding CurrentFileSize}" 
                                                 FontSize="12" 
                                                 FontWeight="SemiBold"
                                                 Margin="0,2,0,8"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Column="1">
                                        <TextBlock Text="الأبعاد:" FontSize="12" Foreground="#666666"/>
                                        <TextBlock Text="{Binding MediaDimensions}" 
                                                 FontSize="12" 
                                                 FontWeight="SemiBold"
                                                 Margin="0,2,0,8"/>
                                        
                                        <TextBlock Text="نوع الملف:" FontSize="12" Foreground="#666666"/>
                                        <TextBlock Text="{Binding MediaType}" 
                                                 FontSize="12" 
                                                 FontWeight="SemiBold"
                                                 Margin="0,2,0,8"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </materialDesign:Card>

                        <!-- CASA Metrics -->
                        <materialDesign:Card Style="{StaticResource CASAPanelStyle}"
                                           Visibility="{Binding HasAnalysisResults, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel>
                                <TextBlock Text="نتائج تحليل CASA" 
                                         FontSize="16" 
                                         FontWeight="SemiBold"
                                         Foreground="#1976D2"
                                         Margin="0,0,0,12"/>

                                <!-- Primary Metrics -->
                                <UniformGrid Columns="2" Margin="0,0,0,8">
                                    <Border Style="{StaticResource CASAMetricStyle}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding SpermCount}" Style="{StaticResource MetricValueStyle}"/>
                                            <TextBlock Text="العدد الإجمالي" Style="{StaticResource MetricLabelStyle}"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <Border Style="{StaticResource CASAMetricStyle}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding MotilityPercentage, StringFormat='{0:F1}%'}" Style="{StaticResource MetricValueStyle}"/>
                                            <TextBlock Text="نسبة الحركة" Style="{StaticResource MetricLabelStyle}"/>
                                        </StackPanel>
                                    </Border>
                                </UniformGrid>

                                <!-- Motion Parameters -->
                                <UniformGrid Columns="2" Margin="0,8">
                                    <Border Style="{StaticResource CASAMetricStyle}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding VCL, StringFormat='{0:F1} μm/s'}" Style="{StaticResource MetricValueStyle}"/>
                                            <TextBlock Text="VCL - السرعة المنحنية" Style="{StaticResource MetricLabelStyle}"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <Border Style="{StaticResource CASAMetricStyle}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding VSL, StringFormat='{0:F1} μm/s'}" Style="{StaticResource MetricValueStyle}"/>
                                            <TextBlock Text="VSL - السرعة المستقيمة" Style="{StaticResource MetricLabelStyle}"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <Border Style="{StaticResource CASAMetricStyle}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding VAP, StringFormat='{0:F1} μm/s'}" Style="{StaticResource MetricValueStyle}"/>
                                            <TextBlock Text="VAP - السرعة المتوسطة" Style="{StaticResource MetricLabelStyle}"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <Border Style="{StaticResource CASAMetricStyle}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding LIN, StringFormat='{0:F1}%'}" Style="{StaticResource MetricValueStyle}"/>
                                            <TextBlock Text="LIN - الخطية" Style="{StaticResource MetricLabelStyle}"/>
                                        </StackPanel>
                                    </Border>
                                </UniformGrid>

                                <!-- Additional Metrics -->
                                <UniformGrid Columns="2" Margin="0,8,0,0">
                                    <Border Style="{StaticResource CASAMetricStyle}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding STR, StringFormat='{0:F1}%'}" Style="{StaticResource MetricValueStyle}"/>
                                            <TextBlock Text="STR - الاستقامة" Style="{StaticResource MetricLabelStyle}"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <Border Style="{StaticResource CASAMetricStyle}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding WOB, StringFormat='{0:F1}%'}" Style="{StaticResource MetricValueStyle}"/>
                                            <TextBlock Text="WOB - التذبذب" Style="{StaticResource MetricLabelStyle}"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <Border Style="{StaticResource CASAMetricStyle}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding ALH, StringFormat='{0:F1} μm'}" Style="{StaticResource MetricValueStyle}"/>
                                            <TextBlock Text="ALH - سعة الرأس الجانبية" Style="{StaticResource MetricLabelStyle}"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <Border Style="{StaticResource CASAMetricStyle}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding BCF, StringFormat='{0:F1} Hz'}" Style="{StaticResource MetricValueStyle}"/>
                                            <TextBlock Text="BCF - تردد التقاطع" Style="{StaticResource MetricLabelStyle}"/>
                                        </StackPanel>
                                    </Border>
                                </UniformGrid>
                            </StackPanel>
                        </materialDesign:Card>

                        <!-- Motility Classification -->
                        <materialDesign:Card Style="{StaticResource CASAPanelStyle}"
                                           Visibility="{Binding HasAnalysisResults, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel>
                                <TextBlock Text="تصنيف الحركة" 
                                         FontSize="16" 
                                         FontWeight="SemiBold"
                                         Foreground="#1976D2"
                                         Margin="0,0,0,12"/>

                                <!-- Motility Categories -->
                                <ItemsControl ItemsSource="{Binding MotilityCategories}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Style="{StaticResource CASAMetricStyle}" Background="{Binding CategoryColor}">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <StackPanel Grid.Column="0">
                                                        <TextBlock Text="{Binding CategoryName}" 
                                                                 FontSize="14" 
                                                                 FontWeight="SemiBold"
                                                                 Foreground="White"/>
                                                        <TextBlock Text="{Binding Description}" 
                                                                 FontSize="11" 
                                                                 Foreground="#E0E0E0"/>
                                                    </StackPanel>

                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding Count}" 
                                                                 FontSize="18" 
                                                                 FontWeight="Bold"
                                                                 Foreground="White"
                                                                 HorizontalAlignment="Center"/>
                                                        <TextBlock Text="{Binding Percentage, StringFormat='({0:F1}%)'}" 
                                                                 FontSize="11" 
                                                                 Foreground="#E0E0E0"
                                                                 HorizontalAlignment="Center"/>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </materialDesign:Card>

                        <!-- Analysis Actions -->
                        <materialDesign:Card Style="{StaticResource CASAPanelStyle}">
                            <StackPanel>
                                <TextBlock Text="إجراءات التحليل" 
                                         FontSize="16" 
                                         FontWeight="SemiBold"
                                         Foreground="#1976D2"
                                         Margin="0,0,0,12"/>

                                <UniformGrid Columns="1">
                                    <Button Content="حفظ النتائج"
                                          Style="{StaticResource AnalysisButtonStyle}"
                                          Background="#4CAF50"
                                          BorderBrush="#4CAF50"
                                          Command="{Binding SaveResultsCommand}"
                                          IsEnabled="{Binding HasAnalysisResults}"/>
                                    
                                    <Button Content="تصدير تقرير PDF"
                                          Style="{StaticResource AnalysisButtonStyle}"
                                          Background="#FF9800"
                                          BorderBrush="#FF9800"
                                          Command="{Binding ExportPDFCommand}"
                                          IsEnabled="{Binding HasAnalysisResults}"/>
                                    
                                    <Button Content="مسح النتائج"
                                          Style="{StaticResource AnalysisButtonStyle}"
                                          Background="#F44336"
                                          BorderBrush="#F44336"
                                          Command="{Binding ClearResultsCommand}"
                                          IsEnabled="{Binding HasAnalysisResults}"/>
                                </UniformGrid>
                            </StackPanel>
                        </materialDesign:Card>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <materialDesign:ColorZone Grid.Row="2" 
                                Mode="Light" 
                                Background="#E0E0E0"
                                Padding="16,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" 
                         Text="{Binding StatusMessage}" 
                         FontSize="12"
                         VerticalAlignment="Center"/>

                <StackPanel Grid.Column="1" 
                          Orientation="Horizontal"
                          VerticalAlignment="Center">
                    <TextBlock Text="وقت التحليل: " 
                             FontSize="11" 
                             Foreground="#666666"/>
                    <TextBlock Text="{Binding AnalysisTime, StringFormat='{0:F1}s'}" 
                             FontSize="11" 
                             FontWeight="SemiBold"
                             Foreground="#1976D2"/>
                </StackPanel>
            </Grid>
        </materialDesign:ColorZone>
    </Grid>
</UserControl>